<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paradox AI - Hybrid</title>
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root { --bg: #09090b; --panel: #18181b; --text: #fafafa; --accent: #3b82f6; --user-msg: #27272a; --ai-msg: #18181b; --border: #27272a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER */
        header { padding: 15px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .brand { font-weight: 700; font-size: 18px; color: var(--accent); display: flex; gap: 8px; align-items: center; letter-spacing: -0.5px; }
        .mode-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; background: #22c55e; color: black; font-weight: bold; text-transform: uppercase; }
        .mode-badge.fallback { background: #eab308; } /* Yellow for fallback */

        /* CHAT AREA */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; line-height: 1.6; font-size: 15px; word-wrap: break-word; position: relative; }
        .user .bubble { background: var(--user-msg); color: white; border-bottom-right-radius: 4px; border: 1px solid var(--border); }
        .ai .bubble { background: var(--ai-msg); color: #d4d4d8; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        
        /* CODE BLOCKS */
        pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px; border: 1px solid var(--border); margin: 10px 0; }
        code { font-family: 'Consolas', monospace; }
        
        /* INPUT AREA */
        .input-wrapper { background: var(--bg); padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: center; }
        .input-box { width: 100%; max-width: 800px; background: var(--panel); border: 1px solid var(--border); border-radius: 24px; display: flex; align-items: flex-end; padding: 8px 15px; transition: 0.2s; }
        .input-box:focus-within { border-color: var(--accent); }
        textarea { flex: 1; background: transparent; border: none; color: white; padding: 10px 5px; font-size: 16px; resize: none; max-height: 150px; min-height: 24px; font-family: inherit; }
        #send-btn { background: var(--accent); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 2px; margin-left: 10px; transition: 0.2s; }
        #send-btn:hover { opacity: 0.9; }
        #send-btn:disabled { background: var(--border); cursor: not-allowed; }

        /* AUTH OVERLAY */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .google-btn { background: white; color: black; padding: 14px 28px; border-radius: 30px; font-weight: 600; border: none; cursor: pointer; display: flex; gap: 10px; align-items: center; font-size: 15px; margin-bottom: 20px; transition: 0.2s; }
        .google-btn:active { transform: scale(0.98); }
        .skip-btn { color: #71717a; background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

    <!-- AUTHENTICATION -->
    <div id="auth-screen">
        <i class="fas fa-cube" style="font-size: 50px; color: var(--accent); margin-bottom: 20px;"></i>
        <h1 style="margin-bottom: 10px;">Paradox AI</h1>
        <p style="color: #a1a1aa; margin-bottom: 40px;">Professional Assistant â€¢ Hybrid Engine</p>
        <button id="login-btn" class="google-btn"><i class="fab fa-google"></i> Sign in with Google</button>
        <button id="skip-btn" class="skip-btn">Continue without signing in</button>
    </div>

    <!-- MAIN APP -->
    <header>
        <div class="brand"><i class="fas fa-robot"></i> Paradox</div>
        <div id="engine-status" class="mode-badge">Initializing...</div>
    </header>

    <div id="chat-container">
        <!-- Messages appear here -->
        <div class="message-row ai">
            <div class="bubble">
                System Online. I am connected via your API key.
                <br>
                If the key fails, I will auto-switch to free mode.
                <br><br>
                How can I help you?
            </div>
        </div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // =======================================================
        // 1. YOUR API KEY (Pasted Here)
        // =======================================================
        const USER_API_KEY = "sk_ei5kY2stkJ8BxRarXVRVnZNIKMzxrhP5";

        // =======================================================
        // 2. FIREBASE CONFIG
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCSiqI0wxTUXpy2H0rAN0tmnd56VRmMbuM",
            authDomain: "paradox-ai-f8ec1.firebaseapp.com",
            databaseURL: "https://paradox-ai-f8ec1-default-rtdb.firebaseio.com",
            projectId: "paradox-ai-f8ec1",
            storageBucket: "paradox-ai-f8ec1.firebasestorage.app",
            messagingSenderId: "148057431428",
            appId: "1:148057431428:web:099161d05905988a6a91d1",
            measurementId: "G-BSN717GWZG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let usingFallback = false;

        // --- AUTH ---
        document.getElementById('login-btn').onclick = () => {
            signInWithPopup(auth, provider).catch(e => alert("Login Error: " + e.message));
        };
        document.getElementById('skip-btn').onclick = () => {
            document.getElementById('auth-screen').style.display = 'none';
            updateStatus(false);
        };
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                updateStatus(false);
            }
        });

        // --- CORE LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            // UI
            appendMessage(text, 'user');
            input.value = '';
            input.style.height = 'auto';
            const btn = document.getElementById('send-btn');
            btn.disabled = true;

            // DB Save
            if (currentUser) {
                push(ref(db, `users/${currentUser.uid}/messages`), { text, role: 'user', timestamp: serverTimestamp() });
            }

            try {
                let aiResponseText = "";

                // STRATEGY 1: TRY USER KEY (OpenRouter/OpenAI Compatible)
                if (!usingFallback) {
                    try {
                        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${USER_API_KEY}`,
                                "Content-Type": "application/json",
                                "HTTP-Referer": "http://localhost",
                                "X-Title": "Paradox App"
                            },
                            body: JSON.stringify({
                                "model": "google/gemini-2.0-flash-exp:free", // Tries Free model first with key
                                "messages": [{ role: "user", content: text }]
                            })
                        });

                        if (!response.ok) throw new Error("Key Failed");
                        const data = await response.json();
                        aiResponseText = data.choices[0].message.content;

                    } catch (keyError) {
                        console.warn("Primary Key Failed, switching to fallback...", keyError);
                        usingFallback = true;
                        updateStatus(true);
                        // Recursive call to fallback logic immediately
                        return await fallbackToPollinations(text, btn);
                    }
                } else {
                    // Already in fallback mode
                    await fallbackToPollinations(text, btn);
                    return; 
                }

                // If Strategy 1 succeeded:
                finishMessage(aiResponseText, btn);

            } catch (finalError) {
                // If everything fails
                appendMessage("System Error: Check internet connection.", 'ai');
                btn.disabled = false;
            }
        }

        // STRATEGY 2: POLLINATIONS (NO KEY / FREE)
        async function fallbackToPollinations(text, btn) {
            try {
                const sys = "You are Paradox AI. Concise and helpful.";
                const url = `https://text.pollinations.ai/${encodeURIComponent(sys + " " + text)}?model=openai`;
                const response = await fetch(url);
                const aiText = await response.text();
                finishMessage(aiText, btn);
            } catch (e) {
                appendMessage("Error: Network totally unreachable.", 'ai');
                btn.disabled = false;
            }
        }

        function finishMessage(aiText, btn) {
            appendMessage(aiText, 'ai');
            if (currentUser) {
                push(ref(db, `users/${currentUser.uid}/messages`), { text: aiText, role: 'model', timestamp: serverTimestamp() });
            }
            btn.disabled = false;
        }

        // --- UI HELPERS ---
        function appendMessage(text, role) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message-row ${role}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            container.appendChild(div);
            div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(isFallback) {
            const badge = document.getElementById('engine-status');
            if (isFallback) {
                badge.textContent = "FREE MODE (BACKUP)";
                badge.className = "mode-badge fallback";
            } else {
                badge.textContent = "PREMIUM (KEY ACTIVE)";
                badge.className = "mode-badge";
            }
        }

        // Listeners
        document.getElementById('send-btn').onclick = sendMessage;
        const tx = document.getElementById('user-input');
        tx.oninput = function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; };
        tx.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }};

    </script>
</body>
</html>
