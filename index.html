<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paradox AI - Ultimate</title>
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <!-- Markdown & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* BASE STYLES */
        :root { --bg-body: #09090b; --bg-sidebar: #121214; --bg-input: #1e1e20; --border: #27272a; --primary: #3b82f6; --text-main: #f4f4f5; --text-muted: #a1a1aa; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
        .brand { padding: 25px 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); }
        #new-chat-btn { margin: 0 15px 10px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text-main); cursor: pointer; display: flex; gap: 10px; align-items: center; }
        #history-wrapper { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .chat-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .chat-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        
        /* PROFILE */
        .profile-section { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-sidebar); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* MAIN AREA */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(9,9,11,0.95); z-index: 10; }
        #model-status { font-size: 11px; background: #222; padding: 4px 10px; border-radius: 10px; color: #888; }
        
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* MESSAGES */
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        .bubble { max-width: 90%; padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.6; }
        .user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #18181b; border: 1px solid var(--border); color: #e4e4e7; border-bottom-left-radius: 2px; width: 100%; max-width: 850px; }
        
        /* --- CODE BLOCKS & ACTIONS (RESTORED) --- */
        .code-block-wrapper { margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; background: #111; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #222; font-size: 12px; color: #aaa; border-bottom: 1px solid #333; }
        .code-actions { display: flex; gap: 8px; }
        .code-btn { background: #333; border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .code-btn:hover { background: #444; }
        .code-btn.preview { background: var(--primary); }
        .code-btn.preview:hover { opacity: 0.9; }
        pre { margin: 0; padding: 15px; overflow-x: auto; }
        
        /* INPUT */
        .input-area { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-body); }
        .input-box { display: flex; align-items: flex-end; background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; padding: 10px; }
        textarea { flex: 1; background: transparent; border: none; color: white; resize: none; min-height: 24px; max-height: 300px; font-size: 15px; font-family: inherit; line-height: 1.5; padding: 0 5px; }
        #send-btn { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; margin-left: 10px; margin-bottom: 2px; display:flex; align-items:center; justify-content:center;}

        /* OVERLAYS */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #preview-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 600px; height: 100%; background: white; z-index: 100; transition: 0.4s; display: flex; flex-direction: column; }
        #preview-panel.open { right: 0; }
        .preview-header { padding: 10px 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #000; }
        iframe { flex: 1; border: none; }
        
        @media (max-width: 768px) { #sidebar { position: absolute; height: 100%; left: -280px; } #sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.5); } }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay">
        <h1>Paradox AI</h1>
        <p style="color: #888;">Code • Memory • Preview</p>
        <button id="login-btn" style="background: white; color: black; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer;">Sign in with Google</button>
        <button id="guest-btn" style="background: transparent; color: #888; border: none; margin-top: 20px; cursor: pointer; text-decoration: underline;">Use as Guest</button>
    </div>

    <!-- PREVIEW PANEL -->
    <div id="preview-panel">
        <div class="preview-header">
            <span><i class="fas fa-play"></i> Live Preview</span>
            <button onclick="document.getElementById('preview-panel').classList.remove('open')" style="border:none; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <iframe id="preview-frame"></iframe>
    </div>

    <!-- SIDEBAR -->
    <nav id="sidebar">
        <div class="brand"><i class="fas fa-cube"></i> PARADOX</div>
        <button id="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
        <div id="history-wrapper"><div id="history-list"></div></div>
        <div class="profile-section" id="user-menu">
            <div class="avatar" id="user-avatar"><i class="fas fa-user"></i></div>
            <div style="flex: 1;">
                <div id="user-name" style="font-size: 14px; font-weight: 600;">Guest</div>
                <div style="font-size: 11px; color: #888;">Online</div>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main id="main">
        <header>
            <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:white; font-size: 20px;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: 600;">Paradox</div>
            <div id="model-status">Auto Engine</div>
        </header>

        <div id="chat-container">
            <div class="message-row ai">
                <div class="bubble">System Online. I remember context and can write/preview code.</div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="user-input" placeholder="Message..."></textarea>
                <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCSiqI0wxTUXpy2H0rAN0tmnd56VRmMbuM",
            authDomain: "paradox-ai-f8ec1.firebaseapp.com",
            databaseURL: "https://paradox-ai-f8ec1-default-rtdb.firebaseio.com",
            projectId: "paradox-ai-f8ec1",
            storageBucket: "paradox-ai-f8ec1.firebasestorage.app",
            messagingSenderId: "148057431428",
            appId: "1:148057431428:web:099161d05905988a6a91d1",
            measurementId: "G-BSN717GWZG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let activeChatId = null;
        let chatContext = []; // MEMORY VARIABLE

        // AUTH
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        document.getElementById('guest-btn').onclick = () => document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('user-menu').onclick = () => { if(currentUser) signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('user-name').textContent = user.displayName;
                if(user.photoURL) document.getElementById('user-avatar').innerHTML = `<img src="${user.photoURL}" style="width:100%;">`;
                loadHistory();
            } else {
                currentUser = null;
                document.getElementById('user-name').textContent = "Guest";
                document.getElementById('history-list').innerHTML = '<div style="padding:10px; font-size:12px; color:#666;">Login to see history</div>';
            }
        });

        // --- ROBUST AI (AUTO-SWITCH + MEMORY) ---
        const models = ['qwen', 'mistral', 'llama', 'searchgpt'];
        let currentModelIndex = 0;

        async function fetchAI(userInput, retries = 0) {
            const modelName = models[currentModelIndex];
            document.getElementById('model-status').innerText = `Using: ${modelName.toUpperCase()}`;

            const systemPrompt = "You are Paradox. Expert AI. Reply in Roman Urdu/Hindi if user speaks it. Remember previous context.";
            
            // CONTEXT MANAGEMENT: Keep last 6 messages to avoid "Too Long" but keep memory
            const limitedContext = chatContext.slice(-6); 
            
            const messages = [
                { role: 'system', content: systemPrompt },
                ...limitedContext,
                { role: 'user', content: userInput }
            ];

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: messages,
                        model: modelName,
                        jsonMode: false
                    })
                });

                if (!response.ok) throw new Error("Busy");
                return await response.text();

            } catch (error) {
                console.log(`${modelName} failed. Switching...`);
                currentModelIndex = (currentModelIndex + 1) % models.length;
                if (retries < 4) return await fetchAI(userInput, retries + 1);
                throw new Error("All servers busy.");
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            appendMessage(text, 'user');
            input.value = '';
            input.style.height = '24px';
            document.getElementById('send-btn').disabled = true;

            // Add User to Memory
            chatContext.push({ role: 'user', content: text });

            if(currentUser) {
                try {
                    if(!activeChatId) {
                        const newRef = push(ref(db, `users/${currentUser.uid}/chats`));
                        activeChatId = newRef.key;
                        set(newRef, { title: text.substring(0, 20), timestamp: serverTimestamp() });
                        loadHistory();
                    }
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text, role: 'user', timestamp: serverTimestamp() });
                } catch(e) {}
            }

            try {
                const aiText = await fetchAI(text);
                appendMessage(aiText, 'ai');
                
                // Add AI to Memory
                chatContext.push({ role: 'assistant', content: aiText });

                if(currentUser && activeChatId) {
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text: aiText, role: 'model', timestamp: serverTimestamp() });
                }

            } catch (error) {
                appendMessage("Error: Network busy. Please try again.", 'ai');
            } finally {
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- MARKDOWN & BUTTONS RESTORED ---
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const safe = encodeURIComponent(code);
            return `<div class="code-block-wrapper">
                <div class="code-header">
                    <span>${language || 'code'}</span>
                    <div class="code-actions">
                        <button class="code-btn" onclick="copyCode('${safe}')"><i class="fas fa-copy"></i> Copy</button>
                        <button class="code-btn preview" onclick="preview('${safe}')"><i class="fas fa-play"></i> Preview</button>
                    </div>
                </div>
                <pre><code class="hljs">${hljs.highlightAuto(code).value}</code></pre>
            </div>`;
        };
        marked.setOptions({ renderer: renderer });

        window.copyCode = (encoded) => {
            navigator.clipboard.writeText(decodeURIComponent(encoded));
            alert("Copied to clipboard!");
        };

        window.preview = (encoded) => {
            document.getElementById('preview-panel').classList.add('open');
            const blob = new Blob([decodeURIComponent(encoded)], {type:'text/html'});
            document.getElementById('preview-frame').src = URL.createObjectURL(blob);
        };

        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message-row ${role === 'model' ? 'ai' : 'user'}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            document.getElementById('chat-container').appendChild(div);
            div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            document.getElementById('chat-container').scrollTop = 99999;
        }

        // --- HISTORY LOADING ---
        function loadHistory() {
            if(!currentUser) return;
            onValue(ref(db, `users/${currentUser.uid}/chats`), (snapshot) => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([id, chat]) => {
                        const div = document.createElement('div');
                        div.className = 'chat-item';
                        div.innerHTML = `<i class="far fa-comment"></i> ${chat.title || 'Chat'}`;
                        div.onclick = () => loadChat(id);
                        list.appendChild(div);
                    });
                }
            });
        }

        function loadChat(id) {
            activeChatId = id;
            chatContext = []; // Reset context for new chat
            document.getElementById('chat-container').innerHTML = '';
            
            onValue(ref(db, `users/${currentUser.uid}/chats/${id}/messages`), (snapshot) => {
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                const data = snapshot.val();
                if(data) {
                    Object.values(data).forEach(m => {
                        appendMessage(m.text, m.role);
                        // REBUILD MEMORY FROM HISTORY
                        chatContext.push({ role: m.role === 'user' ? 'user' : 'assistant', content: m.text });
                    });
                }
            }, { onlyOnce: true });
        }

        document.getElementById('new-chat-btn').onclick = () => {
            activeChatId = null;
            chatContext = [];
            document.getElementById('chat-container').innerHTML = '<div class="message-row ai"><div class="bubble">New chat started.</div></div>';
        };

        const inputField = document.getElementById('user-input');
        inputField.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        inputField.addEventListener('keydown', function(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        document.getElementById('send-btn').onclick = sendMessage;

    </script>
</body>
</html>
