<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paradox AI - Fixed Input</title>
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <!-- Markdown & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* BASE STYLES */
        :root { --bg-body: #09090b; --bg-sidebar: #121214; --bg-input: #1e1e20; --border: #27272a; --primary: #3b82f6; --text-main: #f4f4f5; --text-muted: #a1a1aa; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
        .brand { padding: 25px 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); }
        #new-chat-btn { margin: 0 15px 10px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text-main); cursor: pointer; display: flex; gap: 10px; align-items: center; }
        #history-wrapper { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .chat-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .chat-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        
        /* PROFILE */
        .profile-section { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-sidebar); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* MAIN AREA */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(9,9,11,0.9); }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* MESSAGES */
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.6; }
        .user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #18181b; border: 1px solid var(--border); color: #e4e4e7; border-bottom-left-radius: 2px; width: 100%; max-width: 800px; }
        
        /* LOADING */
        .typing-indicator { display: flex; align-items: center; gap: 5px; padding: 15px 20px; background: #18181b; border: 1px solid var(--border); border-radius: 16px; border-bottom-left-radius: 2px; width: fit-content; }
        .dot { width: 8px; height: 8px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* PREVIEW & INPUT */
        .code-block-wrapper { margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; background: #18181b; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #27272a; font-size: 12px; color: #a1a1aa; }
        .preview-btn { background: var(--primary); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 5px; }
        pre { margin: 0; padding: 15px; overflow-x: auto; }
        
        .input-area { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-body); }
        .input-box { display: flex; align-items: flex-end; background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; padding: 10px; }
        textarea { flex: 1; background: transparent; border: none; color: white; resize: none; height: 24px; max-height: 200px; font-size: 15px; font-family: inherit; line-height: 1.5; padding: 0 5px; }
        #send-btn { background: var(--primary); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; margin-left: 10px; margin-bottom: 2px; }

        /* OVERLAYS */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #preview-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 600px; height: 100%; background: white; z-index: 100; transition: 0.4s; display: flex; flex-direction: column; }
        #preview-panel.open { right: 0; }
        iframe { flex: 1; border: none; }
        
        @media (max-width: 768px) { #sidebar { position: absolute; height: 100%; left: -280px; } #sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.5); } }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay">
        <h1>Paradox AI</h1>
        <p style="color: #888;">Chat Ready</p>
        <button id="login-btn" style="background: white; color: black; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer;">Sign in with Google</button>
        <button id="guest-btn" style="background: transparent; color: #888; border: none; margin-top: 20px; cursor: pointer; text-decoration: underline;">Use as Guest</button>
    </div>

    <!-- PREVIEW PANEL -->
    <div id="preview-panel">
        <div style="padding: 10px; background: #eee; display: flex; justify-content: space-between;">
            <span style="color: black; font-weight: bold;">Preview</span>
            <button onclick="document.getElementById('preview-panel').classList.remove('open')" style="border:none; cursor:pointer;">Close</button>
        </div>
        <iframe id="preview-frame"></iframe>
    </div>

    <!-- SIDEBAR -->
    <nav id="sidebar">
        <div class="brand"><i class="fas fa-cube"></i> PARADOX</div>
        <button id="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
        <div id="history-wrapper"><div id="history-list"></div></div>
        <div class="profile-section" id="user-menu">
            <div class="avatar" id="user-avatar"><i class="fas fa-user"></i></div>
            <div style="flex: 1;">
                <div id="user-name" style="font-size: 14px; font-weight: 600;">Guest</div>
                <div style="font-size: 11px; color: #888;">Online</div>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main id="main">
        <header>
            <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:white; font-size: 20px;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: 600;">Paradox</div>
            <div></div>
        </header>

        <div id="chat-container">
            <div class="message-row ai">
                <div class="bubble">System Online. How can I help?</div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="user-input" placeholder="Message..." rows="1"></textarea>
                <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <script type="module">
        // IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCSiqI0wxTUXpy2H0rAN0tmnd56VRmMbuM",
            authDomain: "paradox-ai-f8ec1.firebaseapp.com",
            databaseURL: "https://paradox-ai-f8ec1-default-rtdb.firebaseio.com",
            projectId: "paradox-ai-f8ec1",
            storageBucket: "paradox-ai-f8ec1.firebasestorage.app",
            messagingSenderId: "148057431428",
            appId: "1:148057431428:web:099161d05905988a6a91d1",
            measurementId: "G-BSN717GWZG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let activeChatId = null;

        // AUTH
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        document.getElementById('guest-btn').onclick = () => document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('user-menu').onclick = () => { if(currentUser) signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('user-name').textContent = user.displayName;
                if(user.photoURL) document.getElementById('user-avatar').innerHTML = `<img src="${user.photoURL}" style="width:100%;">`;
                loadHistory();
            } else {
                currentUser = null;
                document.getElementById('user-name').textContent = "Guest";
                document.getElementById('history-list').innerHTML = '<div style="padding:10px; font-size:12px; color:#666;">Login to see history</div>';
            }
        });

        // --- ANIMATION HELPERS ---
        function showLoading() {
            const container = document.getElementById('chat-container');
            const loader = document.createElement('div');
            loader.id = "loading-bubble";
            loader.className = "message-row ai";
            loader.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>`;
            container.appendChild(loader);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoading() {
            const loader = document.getElementById('loading-bubble');
            if(loader) loader.remove();
        }

        // --- NEW ROBUST API CALL ---
        async function fetchAI(prompt) {
            const seed = Math.floor(Math.random() * 1000000); 
            
            try {
                const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?seed=${seed}`;
                const res = await fetch(url);
                if(res.ok) return await res.text();
            } catch(e) { console.log("Default model busy, trying backup..."); }

            try {
                const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=mistral&seed=${seed}`;
                const res = await fetch(url);
                if(res.ok) return await res.text();
            } catch(e) { console.log("Backup model busy..."); }

            throw new Error("All Servers Busy");
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            // UI Update
            appendMessage(text, 'user');
            input.value = '';
            input.style.height = '24px'; // Reset height after send
            document.getElementById('send-btn').disabled = true;
            showLoading();

            if(currentUser) {
                try {
                    if(!activeChatId) {
                        const newRef = push(ref(db, `users/${currentUser.uid}/chats`));
                        activeChatId = newRef.key;
                        set(newRef, { title: text.substring(0, 20), timestamp: serverTimestamp() });
                        loadHistory();
                    }
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text, role: 'user', timestamp: serverTimestamp() });
                } catch(e) {}
            }

            try {
                const aiText = await fetchAI("You are Paradox, an expert coding assistant. " + text);
                removeLoading();
                appendMessage(aiText, 'ai');

                if(currentUser && activeChatId) {
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text: aiText, role: 'model', timestamp: serverTimestamp() });
                }

            } catch (error) {
                removeLoading();
                appendMessage("Error: Network is extremely busy. Please wait 10 seconds and try again.", 'ai');
            } finally {
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- INPUT HANDLING FIX ---
        const inputField = document.getElementById('user-input');
        
        // 1. Auto-Resize Input
        inputField.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // 2. ENTER to Send, SHIFT+ENTER for New Line
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                sendMessage();      // Trigger send
            }
        });

        document.getElementById('send-btn').onclick = sendMessage;

        // --- HISTORY & HELPERS ---
        function loadHistory() {
            if(!currentUser) return;
            onValue(ref(db, `users/${currentUser.uid}/chats`), (snapshot) => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([id, chat]) => {
                        const div = document.createElement('div');
                        div.className = 'chat-item';
                        div.innerHTML = `<i class="far fa-comment"></i> ${chat.title || 'Chat'}`;
                        div.onclick = () => loadChat(id);
                        list.appendChild(div);
                    });
                }
            });
        }

        function loadChat(id) {
            activeChatId = id;
            document.getElementById('chat-container').innerHTML = '';
            onValue(ref(db, `users/${currentUser.uid}/chats/${id}/messages`), (snapshot) => {
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                const data = snapshot.val();
                if(data) Object.values(data).forEach(m => appendMessage(m.text, m.role));
            }, { onlyOnce: true });
        }

        document.getElementById('new-chat-btn').onclick = () => {
            activeChatId = null;
            document.getElementById('chat-container').innerHTML = '<div class="message-row ai"><div class="bubble">New chat started.</div></div>';
        };

        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const safe = encodeURIComponent(code);
            return `<div class="code-block-wrapper">
                <div class="code-header"><span>${language}</span><button class="preview-btn" onclick="preview('${safe}')">Preview</button></div>
                <pre><code class="hljs">${hljs.highlightAuto(code).value}</code></pre>
            </div>`;
        };
        marked.setOptions({ renderer: renderer });

        window.preview = (c) => {
            document.getElementById('preview-panel').classList.add('open');
            const blob = new Blob([decodeURIComponent(c)], {type:'text/html'});
            document.getElementById('preview-frame').src = URL.createObjectURL(blob);
        };

        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message-row ${role === 'model' ? 'ai' : 'user'}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            document.getElementById('chat-container').appendChild(div);
            div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            document.getElementById('chat-container').scrollTop = 99999;
        }
    </script>
</body>
</html>
