<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paradox AI - Smart Merge</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root { --bg-body: #09090b; --bg-sidebar: #121214; --bg-input: #1e1e20; --border: #27272a; --primary: #3b82f6; --text-main: #f4f4f5; --text-muted: #a1a1aa; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
        .brand { padding: 25px 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); }
        #new-chat-btn { margin: 0 15px 10px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text-main); cursor: pointer; display: flex; gap: 10px; align-items: center; }
        #history-wrapper { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .chat-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .chat-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        
        .profile-section { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-sidebar); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* MAIN */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(9,9,11,0.9); }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* MESSAGES */
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.6; }
        .user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #18181b; border: 1px solid var(--border); color: #e4e4e7; border-bottom-left-radius: 2px; width: 100%; max-width: 800px; }
        
        /* LOADING */
        .typing-indicator { display: flex; align-items: center; gap: 5px; padding: 15px 20px; background: #18181b; border: 1px solid var(--border); border-radius: 16px; border-bottom-left-radius: 2px; width: fit-content; }
        .dot { width: 8px; height: 8px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* PREVIEW & INPUT */
        .code-block-wrapper { margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; background: #18181b; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #27272a; font-size: 12px; color: #a1a1aa; }
        .preview-btn { background: var(--primary); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 5px; }
        pre { margin: 0; padding: 15px; overflow-x: auto; }
        
        .input-area { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-body); display: flex; flex-direction: column; gap: 10px; }
        
        /* Fixed Continue Button */
        #continue-btn {
            align-self: center;
            background: #27272a;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        #continue-btn:hover { background: rgba(59, 130, 246, 0.1); }
        #continue-btn.loading { opacity: 0.6; cursor: wait; }

        .input-box { display: flex; align-items: flex-end; background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; padding: 10px; }
        
        textarea { flex: 1; background: transparent; border: none; color: white; resize: none; min-height: 24px; max-height: 300px; font-size: 15px; font-family: inherit; line-height: 1.5; padding: 0 5px; }
        #send-btn { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; margin-left: 10px; margin-bottom: 2px; display:flex; align-items:center; justify-content:center;}

        #auth-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #preview-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 600px; height: 100%; background: white; z-index: 100; transition: 0.4s; display: flex; flex-direction: column; }
        #preview-panel.open { right: 0; }
        iframe { flex: 1; border: none; }
        
        @media (max-width: 768px) { #sidebar { position: absolute; height: 100%; left: -280px; } #sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.5); } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <h1>Paradox AI</h1>
        <p style="color: #888;">Seamless Coding Engine</p>
        <button id="login-btn" style="background: white; color: black; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer;">Sign in with Google</button>
        <button id="guest-btn" style="background: transparent; color: #888; border: none; margin-top: 20px; cursor: pointer; text-decoration: underline;">Use as Guest</button>
    </div>

    <div id="preview-panel">
        <div style="padding: 10px; background: #eee; display: flex; justify-content: space-between;">
            <span style="color: black; font-weight: bold;">Preview</span>
            <button onclick="document.getElementById('preview-panel').classList.remove('open')" style="border:none; cursor:pointer;">Close</button>
        </div>
        <iframe id="preview-frame"></iframe>
    </div>

    <nav id="sidebar">
        <div class="brand"><i class="fas fa-cube"></i> PARADOX</div>
        <button id="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
        <div id="history-wrapper"><div id="history-list"></div></div>
        <div class="profile-section" id="user-menu">
            <div class="avatar" id="user-avatar"><i class="fas fa-user"></i></div>
            <div style="flex: 1;">
                <div id="user-name" style="font-size: 14px; font-weight: 600;">Guest</div>
                <div style="font-size: 11px; color: #888;">Online</div>
            </div>
        </div>
    </nav>

    <main id="main">
        <header>
            <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:white; font-size: 20px;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: 600;">Paradox</div>
            <div></div>
        </header>

        <div id="chat-container">
            <div class="message-row ai">
                <div class="bubble">
                    System Online. <br>
                    Ab <b>Continue</b> dabane par code alag box mein nahi, balki purane code mein hi jud jayega.
                </div>
            </div>
        </div>

        <div class="input-area">
            <button id="continue-btn" onclick="continueGenerating()">
                <i class="fas fa-play"></i> Continue Code (Merge)
            </button>

            <div class="input-box">
                <textarea id="user-input" placeholder="Message... (Shift+Enter for new line)" rows="1"></textarea>
                <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSiqI0wxTUXpy2H0rAN0tmnd56VRmMbuM",
            authDomain: "paradox-ai-f8ec1.firebaseapp.com",
            databaseURL: "https://paradox-ai-f8ec1-default-rtdb.firebaseio.com",
            projectId: "paradox-ai-f8ec1",
            storageBucket: "paradox-ai-f8ec1.firebasestorage.app",
            messagingSenderId: "148057431428",
            appId: "1:148057431428:web:099161d05905988a6a91d1",
            measurementId: "G-BSN717GWZG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let activeChatId = null;
        let chatContext = [];
        
        // --- KEY VARIABLE FOR MERGING ---
        let lastAiRawText = ""; 

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        document.getElementById('guest-btn').onclick = () => document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('user-menu').onclick = () => { if(currentUser) signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('user-name').textContent = user.displayName;
                if(user.photoURL) document.getElementById('user-avatar').innerHTML = `<img src="${user.photoURL}" style="width:100%;">`;
                loadHistory();
            } else {
                currentUser = null;
                document.getElementById('user-name').textContent = "Guest";
                document.getElementById('history-list').innerHTML = '<div style="padding:10px; font-size:12px; color:#666;">Login to see history</div>';
            }
        });

        function showLoading() {
            const container = document.getElementById('chat-container');
            const loader = document.createElement('div');
            loader.id = "loading-bubble";
            loader.className = "message-row ai";
            loader.innerHTML = `<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
            container.appendChild(loader);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoading() {
            const loader = document.getElementById('loading-bubble');
            if(loader) loader.remove();
        }

        function showContinueBtn() { document.getElementById('continue-btn').style.display = 'flex'; }
        function hideContinueBtn() { document.getElementById('continue-btn').style.display = 'none'; }

        async function fetchAI(userInput) {
            const seed = Math.floor(Math.random() * 1000000); 
            const systemMessage = {
                role: 'system',
                content: "You are Paradox. If user speaks Roman Urdu/Hindi, reply in that. If writing code, provide full code. IMPORTANT: If you are continuing a cut-off code, START DIRECTLY from where you left off, do NOT repeat the start."
            };

            const messages = [ systemMessage, ...chatContext.slice(-4), { role: 'user', content: userInput } ];

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages, model: 'searchgpt', jsonMode: false })
                });
                if(response.ok) return await response.text();
            } catch(e) { console.log("Primary model busy..."); }

            const response = await fetch('https://text.pollinations.ai/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: messages, model: 'mistral', jsonMode: false })
            });
            if(!response.ok) throw new Error("Busy");
            return await response.text();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            hideContinueBtn();
            appendMessage(text, 'user');
            input.value = '';
            input.style.height = '24px';
            document.getElementById('send-btn').disabled = true;
            showLoading();

            chatContext.push({ role: 'user', content: text });

            if(currentUser) {
                try {
                    if(!activeChatId) {
                        const newRef = push(ref(db, `users/${currentUser.uid}/chats`));
                        activeChatId = newRef.key;
                        set(newRef, { title: text.substring(0, 20), timestamp: serverTimestamp() });
                        loadHistory();
                    }
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text, role: 'user', timestamp: serverTimestamp() });
                } catch(e) {}
            }

            try {
                const aiText = await fetchAI(text);
                removeLoading();
                
                // Save raw text for merging later
                lastAiRawText = aiText;
                
                appendMessage(aiText, 'ai');
                chatContext.push({ role: 'assistant', content: aiText });

                if(currentUser && activeChatId) {
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text: aiText, role: 'model', timestamp: serverTimestamp() });
                }
                showContinueBtn();

            } catch (error) {
                removeLoading();
                appendMessage("Error: Network busy.", 'ai');
            } finally {
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- SMART MERGE CONTINUE LOGIC ---
        window.continueGenerating = async function() {
            const btn = document.getElementById('continue-btn');
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Continuing...';
            
            // Ask AI to continue
            const prompt = "Please continue generating the previous code/response EXACTLY from where it cut off. Do not add any intro text.";
            // Don't show user bubble for continue to keep UI clean
            chatContext.push({ role: 'user', content: prompt });

            try {
                const newChunk = await fetchAI(prompt);
                
                // MERGE: Combine old text + new chunk
                lastAiRawText += "\n" + newChunk;
                
                // Update Context with merged full text
                chatContext.push({ role: 'assistant', content: newChunk });

                // UI MAGIC: Update the LAST message bubble instead of creating a new one
                const bubbles = document.querySelectorAll('.message-row.ai .bubble');
                const lastBubble = bubbles[bubbles.length - 1];
                
                if(lastBubble) {
                    // Re-render the combined text
                    lastBubble.innerHTML = marked.parse(lastAiRawText);
                    lastBubble.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                } else {
                    // Fallback just in case
                    appendMessage(newChunk, 'ai');
                }

                if(currentUser && activeChatId) {
                    // Note: We save the chunk separately in DB, but display merged in current session
                    push(ref(db, `users/${currentUser.uid}/chats/${activeChatId}/messages`), { text: newChunk, role: 'model', timestamp: serverTimestamp() });
                }
                
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-play"></i> Continue Code (Merge)';

            } catch (e) {
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-redo"></i> Retry Continue';
                alert("Could not fetch more code. Try again.");
            }
        }

        const inputField = document.getElementById('user-input');
        inputField.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        inputField.addEventListener('keydown', function(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        document.getElementById('send-btn').onclick = sendMessage;

        function loadHistory() {
            if(!currentUser) return;
            onValue(ref(db, `users/${currentUser.uid}/chats`), (snapshot) => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([id, chat]) => {
                        const div = document.createElement('div');
                        div.className = 'chat-item';
                        div.innerHTML = `<i class="far fa-comment"></i> ${chat.title || 'Chat'}`;
                        div.onclick = () => loadChat(id);
                        list.appendChild(div);
                    });
                }
            });
        }

        function loadChat(id) {
            activeChatId = id;
            chatContext = [];
            hideContinueBtn();
            document.getElementById('chat-container').innerHTML = '';
            onValue(ref(db, `users/${currentUser.uid}/chats/${id}/messages`), (snapshot) => {
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                const data = snapshot.val();
                if(data) {
                    Object.values(data).forEach(m => {
                        appendMessage(m.text, m.role);
                        // For loaded chats, we treat the last message as the "base" for merging if needed
                        if(m.role === 'model') lastAiRawText = m.text;
                        chatContext.push({ role: m.role === 'user' ? 'user' : 'assistant', content: m.text });
                    });
                }
            }, { onlyOnce: true });
        }

        document.getElementById('new-chat-btn').onclick = () => {
            activeChatId = null;
            chatContext = [];
            hideContinueBtn();
            document.getElementById('chat-container').innerHTML = '<div class="message-row ai"><div class="bubble">System Online.</div></div>';
        };

        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const safe = encodeURIComponent(code);
            return `<div class="code-block-wrapper">
                <div class="code-header"><span>${language}</span><button class="preview-btn" onclick="preview('${safe}')">Preview</button></div>
                <pre><code class="hljs">${hljs.highlightAuto(code).value}</code></pre>
            </div>`;
        };
        marked.setOptions({ renderer: renderer });

        window.preview = (c) => {
            document.getElementById('preview-panel').classList.add('open');
            const blob = new Blob([decodeURIComponent(c)], {type:'text/html'});
            document.getElementById('preview-frame').src = URL.createObjectURL(blob);
        };

        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message-row ${role === 'model' ? 'ai' : 'user'}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            document.getElementById('chat-container').appendChild(div);
            div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            document.getElementById('chat-container').scrollTop = 99999;
        }
    </script>
</body>
</html>
